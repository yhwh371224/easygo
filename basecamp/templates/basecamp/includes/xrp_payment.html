{% extends 'basecamp/easygo_base.html' %}
{% block content %}
<section class="container position-relative zindex-5 px-0 px-xl-3">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-8 pb-2 mb-5">
            <div class="card border-1 shadow-lg" style="padding:2rem;">
                <h5>Enter Your Payment Details</h5>
                <p>Enter your AUD amount and your email to calculate the XRP payment.</p>
                <input type="number" step="0.01" id="aud_amount" class="form-control" placeholder="AUD Amount"><br>
                <input type="email" id="email" class="form-control" placeholder="Email"><br>
                <label>
                    <input type="checkbox" id="send_email"> Send payment instructions to my email
                </label><br><br>
                <button class="btn btn-primary" id="calculate_btn">Calculate XRP</button>

                <hr>
                <div id="result" style="display:none;">
                    <h5>Payment Instructions</h5>
                    <pre id="payment_info"></pre>
                    <button class="btn btn-warning mb-3" onclick="copyAll()">Copy All Payment Info</button>
                    <p>Or scan QR code:</p>
                    <img id="qr_code" class="img-fluid" alt="XRP QR Code">
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.getElementById("calculate_btn").addEventListener("click", function() {
    const email = document.getElementById("email").value;
    const aud_amount = document.getElementById("aud_amount").value;
    const send_email = document.getElementById("send_email").checked;

    fetch("{% url 'blog:pay_xrp' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: `email=${encodeURIComponent(email)}&aud_amount=${encodeURIComponent(aud_amount)}&send_email=${send_email ? "on" : ""}`
    })
    .then(response => response.json())
    .then(data => {
        if(data.error){
            alert(data.error);
            return;
        }
        const paymentText = `Send ${data.xrp_amount} XRP to:\nAddress: ${data.xrp_address}\nDestination Tag: ${data.dest_tag}`;
        document.getElementById("payment_info").innerText = paymentText;
        document.getElementById("qr_code").src = "data:image/png;base64," + data.qr_base64;
        document.getElementById("result").style.display = "block";
    })
    .catch(err => alert("Error fetching XRP amount"));
});

function copyAll() {
    const text = document.getElementById("payment_info").innerText;
    navigator.clipboard.writeText(text).then(() => alert("All payment info copied!"));
}
</script>
{% endblock %}
