{% extends "easygo_review/base_verse.html" %}

{% block content %}

<style>
  /* 전체 페이지 영역 */
  .verse-page {
    height: 100vh;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-image: url('{{ image_path }}');
    background-size: cover;
    background-position: center center;
  }

  /* 배경 어둡게 (글씨 가독성 향상용) */
  .verse-overlay {
    background: rgba(0, 0, 0, 0.35);
    padding: 20px;
    max-width: 92%;
    width: 100%;
    box-sizing: border-box;
    border-radius: 8px;
  }

  /* 본문 텍스트 */
  .verse-text {
    margin: 0;
    color: #ffffff;
    line-height: 1.28;
    word-wrap: break-word;
    white-space: pre-wrap; /* 줄바꿈 유지 */
    text-align: center;
    font-family: "Noto Sans KR", Arial, sans-serif;
    font-size: 6vh; /* 기본 크기 */
    max-height: 88vh;
    overflow: hidden; /* 혹시 넘칠 때 대비 */
  }

  /* 모바일 기기 (폭 480px 이하) */
  @media (max-width: 480px) {
    .verse-text {
      font-size: 5.4vh;
      line-height: 1.16;
    }
  }
</style>

<div class="verse-page">
  <div class="verse-overlay" id="verse-overlay">
    <p id="verse-text" class="verse-text">{{ verse_text|linebreaksbr }}</p>
  </div>
</div>

<script>
/*
  Responsive text fit using ResizeObserver + debounce.
  Ensures text always fits inside the overlay box without overflow.
*/
(function() {
  const textEl = document.getElementById('verse-text');
  const wrapper = document.getElementById('verse-overlay');
  if (!textEl || !wrapper) return;

  function debounce(fn, ms) {
    let t;
    return function() {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, arguments), ms);
    };
  }

  function fits() {
    return (
      textEl.scrollHeight <= wrapper.clientHeight &&
      textEl.scrollWidth <= wrapper.clientWidth
    );
  }

  function adjust() {
    const style = window.getComputedStyle(textEl);
    let fontSize = parseFloat(style.fontSize);
    if (!fontSize || isNaN(fontSize)) {
      fontSize = Math.max(Math.floor(window.innerHeight * 0.06), 12);
      textEl.style.fontSize = fontSize + 'px';
    }

    const step = 0.75;
    const minSize = 10;
    while (!fits() && fontSize > minSize) {
      fontSize = Math.max(minSize, fontSize - step);
      textEl.style.fontSize = fontSize + 'px';
    }
  }

  const debouncedAdjust = debounce(adjust, 120);

  window.addEventListener('load', debouncedAdjust);
  window.addEventListener('orientationchange', debouncedAdjust);
  window.addEventListener('resize', debouncedAdjust);

  if ('ResizeObserver' in window) {
    const ro = new ResizeObserver(debouncedAdjust);
    ro.observe(wrapper);
  } else {
    setInterval(debouncedAdjust, 800);
  }

  setTimeout(debouncedAdjust, 300);
  setTimeout(debouncedAdjust, 1200);
})();
</script>

{% endblock %}
